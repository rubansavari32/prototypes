<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GGI Shuttle â€” Next Bus Visual (animated)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #071223;
            --card: #071523;
            --muted: #98a7bb;
            --accent: #10b98a;
            --glass: rgba(255, 255, 255, 0.02);
            --glass-2: rgba(255, 255, 255, 0.03);
            --white: #e9f2fb;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
            margin: 0;
            background:
                radial-gradient(1200px 500px at 10% 5%, rgba(16, 185, 129, 0.04), transparent 8%),
                linear-gradient(180deg, #041122 0%, #061628 60%);
            color: var(--white);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 28px
        }

        .app {
            width: 100%;
            max-width: 1040px
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px
        }

        h1 {
            margin: 0;
            font-size: 20px
        }

        .card {
            background: linear-gradient(180deg, var(--card), #05131a);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(6px)
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 18px
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 8px
        }

        select,
        input[type="time"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: var(--glass);
            color: inherit
        }

        .controls {
            display: grid;
            gap: 12px
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        button {
            background: var(--accent);
            border: none;
            color: #012018;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .statusCard {
            padding: 14px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(16, 185, 138, 0.03), rgba(16, 185, 138, 0.01));
            border: 1px solid rgba(16, 185, 138, 0.08)
        }

        .controlsCard {
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01))
        }

        .findRow {
            margin-top: 6px;
            display: flex;
            gap: 10px;
            align-items: center
        }

        .upcomingArea {
            margin-top: 16px;
            padding: 14px;
            border-radius: 10px;
            background: var(--glass-2);
            border: 1px solid rgba(255, 255, 255, 0.03)
        }

        .routeVis {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.5), rgba(2, 6, 23, 0.35));
            border-radius: 10px
        }

        .stopBox {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            text-align: center
        }

        .stopName {
            font-weight: 700;
            font-size: 16px
        }

        .stopTime {
            margin-top: 8px;
            color: var(--muted);
            font-weight: 600
        }

        .connector {
            flex: 2;
            position: relative;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .dottedLine {
            position: absolute;
            left: 6%;
            right: 6%;
            height: 2px;
            border-bottom: 2px dotted rgba(255, 255, 255, 0.06);
            top: 50%
        }

        .busDot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px
        }

        .busIcon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(180deg, var(--accent), #06a67a);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #012018;
            font-weight: 800;
            box-shadow: 0 6px 18px rgba(7, 88, 64, 0.25)
        }

        .etaSmall {
            font-size: 13px;
            color: var(--muted)
        }

        .upList {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px
        }

        .upItem {
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.06);
            margin-right: 8px
        }

        .mini {
            font-size: 13px;
            color: var(--muted)
        }

        .footerNote {
            margin-top: 10px;
            color: var(--muted);
            font-size: 13px
        }

        @media (max-width:980px) {
            .grid {
                grid-template-columns: 1fr
            }

            .connector {
                height: 84px
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div class="card" style="display:flex;align-items:center;gap:12px;padding:10px 14px">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none">
                    <path d="M3 13.5V9a6 6 0 016-6h6a6 6 0 016 6v4.5" stroke="#10b98a" stroke-width="1.4"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <rect x="3" y="13.5" width="18" height="6" rx="1.2" stroke="#10b98a" stroke-width="1.4" />
                </svg>
                <div>
                    <h1>GGI Shuttle â€” Next Bus Visual</h1>
                    <div class="muted">Pick origin & destination â€” time auto-detected (editable)</div>
                </div>
            </div>
        </header>

        <div class="grid">
            <div class="controlsCard card">
                <div class="controls">
                    <div>
                        <label>Current location</label>
                        <select id="origin">
                            <option>Choose...</option>
                            <option>Al Nahda</option>
                            <option selected>Mamzar</option>
                            <option>GGI</option>
                            <option>Stadium</option>
                        </select>
                    </div>

                    <div>
                        <label>Destination</label>
                        <select id="destination">
                            <option>Choose...</option>
                            <option>Al Nahda</option>
                            <option>Mamzar</option>
                            <option>GGI</option>
                            <option>Stadium</option>
                        </select>
                    </div>

                    <div>
                        <label>Current time (editable)</label>
                        <div class="row">
                            <input id="timeInput" type="time" />
                            <button id="nowBtn" title="Use current system time">Use Now</button>
                        </div>
                        <div class="muted mini">You can edit time to test scenarios. Every 10s the animation updates
                            using chosen time.</div>
                    </div>

                    <div class="findRow">
                        <button id="findBtn">Find next bus</button>
                        <div class="muted mini">or press Enter</div>
                    </div>

                    <div class="upcomingArea" id="visualArea" style="margin-top:14px;">
                        <div class="routeVis" id="routeVis">
                            <div class="stopBox">
                                <div class="stopName" id="leftStop">--</div>
                                <div class="stopTime" id="leftTime">--:--</div>
                                <div class="mini" id="leftLabel">departure</div>
                            </div>

                            <div class="connector">
                                <div class="dottedLine"></div>
                                <div class="busDot" id="busDot" style="left:6%">
                                    <div class="busIcon">ðŸšŒ</div>
                                    <div class="etaSmall" id="busETA">--</div>
                                </div>
                            </div>

                            <div class="stopBox">
                                <div class="stopName" id="rightStop">--</div>
                                <div class="stopTime" id="rightTime">--:--</div>
                                <div class="mini" id="rightLabel">arrival</div>
                            </div>
                        </div>

                        <div id="upcomingList" style="margin-top:12px">
                            <div class="muted mini">Upcoming schedule (origin â‡¢ destination)</div>
                            <div class="upList" id="upListGrid"></div>
                        </div>
                    </div>

                </div>
            </div>

            <div>
                <div class="card statusCard">
                    <div class="muted mini">Status</div>
                    <div id="status" style="margin-top:10px">
                        <div class="mini">Waiting for input</div>
                    </div>

                    <div
                        style="margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(16,185,138,0.03), rgba(16,185,138,0.01));border:1px solid rgba(16,185,138,0.08)">
                        <div class="muted mini">Next departure</div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
                            <div>
                                <div style="font-size:22px;font-weight:800" id="nextTime">--:--</div>
                                <div class="mini muted" id="nextFrom">--</div>
                            </div>
                            <div style="text-align:right">
                                <div class="mini muted">Time remaining</div>
                                <div style="font-size:22px;font-weight:800" id="minutesRemain">--</div>
                                <div class="mini muted">minutes</div>
                            </div>
                        </div>

                        <div style="margin-top:12px">
                            <div class="muted mini">Upcoming (next 8)</div>
                            <div id="upcomingShort" style="margin-top:8px"></div>
                        </div>
                    </div>

                    <div class="footerNote">Sample timetable embedded. I can replace it with your full parsed timetable.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* ---------- Timetable Data ---------- */
        const timetable = {

            "Al Nahda": {
                // GGI Shuttle (Mon-Sat)
                ggiMonSat: ["05:15", "06:10", "06:30", "06:55", "07:15", "07:50", "08:15", "09:00", "10:10", "11:10", "12:10", "12:45", "13:10", "13:40", "14:10", "14:30", "14:55", "15:35", "16:00", "16:35", "17:15", "17:50", "18:20", "18:50", "19:15", "19:45", "20:10", "20:45", "21:05", "21:15", "22:00", "22:20", "22:45", "23:05"],
                // GGI Shuttle (Sunday)
                ggiSun: ["09:20", "11:10", "12:10", "13:05", "13:25", "14:10", "14:30", "14:50", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "19:50", "20:15", "20:45", "21:20", "22:10", "22:40", "23:00"],

                // Stadium Shuttle (Mon-Sat)
                stadiumMonSat: ["05:20", "06:15", "06:35", "07:15", "07:50", "08:15", "09:10", "10:10", "11:10", "12:10", "12:45", "13:10", "13:40", "14:15", "14:40", "15:25", "16:00", "16:30", "17:15", "17:50", "18:25", "18:50", "19:15", "19:45", "20:10", "20:55", "21:10", "21:50", "22:15", "22:30"],
                // Stadium Shuttle (Sunday)
                stadiumSun: ["09:20", "11:10", "12:10", "12:55", "13:25", "14:10", "14:30", "14:45", "15:30", "15:55", "16:25", "17:00", "17:30", "18:00", "18:30", "18:55", "19:25", "19:55", "20:20", "21:00", "21:20", "22:25"]
            },

            "Mamzar": {
                // GGI Shuttle Outbound to GGI (Mon-Sat)
                ggiOutMonSat: ["05:25", "06:20", "06:40", "07:05", "07:30", "08:00", "08:30", "09:10", "10:20", "11:20", "12:20", "13:00", "13:25", "13:50", "14:20", "14:40", "15:05", "15:45", "16:10", "16:50", "17:25", "18:00", "18:35", "19:00", "19:30", "20:00", "20:25", "21:00", "21:20", "21:30", "22:10", "22:30", "22:55", "23:15"],
                // GGI Shuttle Outbound to GGI (Sunday)
                ggiOutSun: ["09:30", "11:20", "12:20", "13:15", "13:35", "14:20", "14:40", "15:00", "15:40", "16:10", "16:40", "17:10", "17:40", "18:10", "18:40", "19:10", "19:40", "20:00", "20:25", "20:55", "21:30", "22:20", "22:50", "23:10"],

                // GGI Shuttle Return to Al Nahda (Mon-Sat)
                ggiRetMonSat: ["00:25", "01:25", "06:48", "07:10", "07:35", "08:00", "08:25", "08:55", "09:35", "10:50", "11:50", "12:50", "13:55", "14:20", "14:48", "15:10", "15:35", "16:15", "16:38", "17:20", "17:55", "18:30", "19:05", "19:30", "20:05", "20:30", "20:55", "21:28", "21:50", "22:00", "22:38", "22:58", "23:23", "23:45"],
                // GGI Shuttle Return to Al Nahda (Sunday)
                ggiRetSun: ["00:25", "10:55", "11:50", "12:45", "13:45", "14:05", "14:50", "15:10", "15:30", "16:10", "16:40", "17:10", "17:40", "18:10", "18:40", "19:10", "19:40", "20:10", "20:30", "20:55", "21:25", "22:00", "22:50", "23:20", "23:40"],

                // Stadium Shuttle (Mon-Sat)
                stadiumMonSat: ["00:30", "05:40", "06:35", "06:55", "07:40", "08:10", "08:40", "09:30", "10:30", "11:30", "12:30", "13:10", "13:40", "14:10", "14:40", "15:05", "15:45", "16:15", "16:50", "17:35", "18:10", "18:45", "19:10", "19:40", "20:10", "20:35", "21:20", "21:35", "22:08", "22:35", "22:50", "23:15"],
                // Stadium Shuttle (Sunday)
                stadiumSun: ["09:30", "11:20", "12:20", "13:05", "13:35", "14:20", "14:42", "14:55", "15:40", "16:05", "16:35", "17:10", "17:40", "18:10", "18:40", "19:05", "19:35", "20:05", "20:30", "21:10", "21:30", "22:35"]
            },

            "GGI": {
                // Departure from GGI (Mon-Sat)
                monSat: ["00:10", "01:10", "05:40", "06:35", "06:55", "07:20", "07:45", "08:15", "08:45", "09:25", "10:35", "11:35", "12:35", "13:15", "13:40", "14:05", "14:35", "14:55", "15:20", "16:00", "16:25", "17:05", "17:40", "18:15", "18:50", "19:15", "19:45", "20:15", "20:40", "21:15", "21:35", "21:45", "22:25", "22:45", "23:10", "23:30"],
                // Departure from GGI (Sunday)
                sunday: ["00:10", "09:45", "10:35", "11:35", "12:35", "13:30", "13:50", "14:35", "14:55", "15:15", "15:55", "16:25", "16:55", "17:25", "17:55", "18:25", "18:55", "19:25", "19:55", "20:15", "20:40", "21:10", "21:45", "22:35", "23:05", "23:25"]
            },

            "Stadium": {
                monSat: {
                    toAlNahda: ["00:30", "05:40", "06:35", "06:55", "07:40", "08:10", "08:40", "09:30", "10:30", "11:30", "12:30", "13:10", "13:40", "14:10", "14:40", "15:05", "15:45", "16:15", "16:50", "17:35", "18:10", "18:45", "19:10", "19:40", "20:10", "20:35", "21:20", "21:35", "22:08", "22:35", "22:50", "23:15"],
                    toMamzar: ["00:30", "05:40", "06:35", "06:55", "07:40", "08:10", "08:40", "09:30", "10:30", "11:30", "12:30", "13:10", "13:40", "14:10", "14:40", "15:05", "15:45", "16:15", "16:50", "17:35", "18:10", "18:45", "19:10", "19:40", "20:10", "20:35", "21:20", "21:35", "22:08", "22:35", "22:50", "23:15"]
                },
                sunday: {
                    toAlNahda: ["00:40", "09:40", "10:45", "11:30", "12:30", "13:13", "13:43", "14:30", "14:50", "15:10", "15:50", "16:13", "16:43", "17:20", "17:50", "18:20", "18:50", "19:13", "19:43", "20:13", "20:40", "21:20", "21:40", "22:45", "23:15"],
                    toMamzar: ["00:40", "09:40", "10:45", "11:30", "12:30", "13:13", "13:43", "14:30", "14:50", "15:10", "15:50", "16:13", "16:43", "17:20", "17:50", "18:20", "18:50", "19:13", "19:43", "20:13", "20:40", "21:20", "21:40", "22:45", "23:15"]
                }
            }

        };

        /* heuristics for travel durations (minutes) - adjust to your real parsed data later */
        const TRAVEL_MINUTES = {
            "Mamzar->GGI": 15,
            "Mamzar->Al Nahda": 5,
            "GGI->Mamzar": 13,
            "GGI->Al Nahda": 33,
            "Al Nahda->Mamzar": 15,
            "Al Nahda->GGI": 30,
            "Al Nahda->Stadium": 20,
            "Stadium->Al Nahda": 20,
            "Mamzar->Stadium": 10,
            "Stadium->Mamzar": 10
        };

        /* helpers */
        function parseHM(hm) {
            const [h, m] = hm.split(':').map(x => parseInt(x, 10));
            return { h, m };
        }
        function makeDateFromHM(hm, baseDate = new Date()) {
            const { h, m } = parseHM(hm);
            const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h, m, 0);
            return normalizeScheduleDate(d, baseDate);
        }
        function normalizeScheduleDate(schedDate, nowDate) {
            // if schedule time is >12 hours behind, consider next day (handles midnight wrap)
            if ((schedDate - nowDate) < -12 * 3600 * 1000) {
                schedDate.setDate(schedDate.getDate() + 1);
            }
            return schedDate;
        }
        function minutesBetween(a, b) { return Math.round((b - a) / 60000); }

        /* find next schedule list for origin->dest */
        function getScheduleList(origin, dest) {
            // Check if today is Sunday (0 = Sunday in JS)
            const isSunday = new Date().getDay() === 0;

            let list = [];
            let type = "";

            // --- Stadium Logic ---
            if (dest === "Stadium") {
                type = "STD BUS";
                if (origin === "Al Nahda") list = isSunday ? timetable["Al Nahda"].stadiumSun : timetable["Al Nahda"].stadiumMonSat;
                if (origin === "Mamzar") list = isSunday ? timetable.Mamzar.stadiumSun : timetable.Mamzar.stadiumMonSat;
            }
            else if (origin === "Stadium") {
                type = "STD BUS";
                if (dest === "Al Nahda") list = isSunday ? timetable.Stadium.sunday.toAlNahda : timetable.Stadium.monSat.toAlNahda;
                if (dest === "Mamzar") list = isSunday ? timetable.Stadium.sunday.toMamzar : timetable.Stadium.monSat.toMamzar;
            }

            // --- GGI Logic ---
            else if (dest === "GGI") {
                type = "GGI BUS";
                if (origin === "Al Nahda") list = isSunday ? timetable["Al Nahda"].ggiSun : timetable["Al Nahda"].ggiMonSat;
                if (origin === "Mamzar") list = isSunday ? timetable.Mamzar.ggiOutSun : timetable.Mamzar.ggiOutMonSat;
            }
            else if (origin === "GGI") {
                type = "GGI BUS";
                // Departure from GGI is the same list regardless of dest (usually)
                // but the arrival time estimation will differ
                list = isSunday ? timetable.GGI.sunday : timetable.GGI.monSat;
            }
            else if (origin === "Mamzar" && dest === "Al Nahda") {
                type = "GGI BUS"; // This is the return leg of GGI bus
                list = isSunday ? timetable.Mamzar.ggiRetSun : timetable.Mamzar.ggiRetMonSat;
            }
            else if (origin === "Al Nahda" && dest === "Mamzar") {
                type = "GGI BUS"; // This is outbound
                list = isSunday ? timetable["Al Nahda"].ggiSun : timetable["Al Nahda"].ggiMonSat;
            }

            return { list: list || [], type };
        }

        function estimateArrival(origin, dest, departDate, departStr, busType) {
            // try to find exact arrival from aligned arrays for GGI buses
            // Note: This relies on the arrays being perfectly aligned in length/order.
            // If they are not, we fall back to heuristics.

            const isSunday = new Date().getDay() === 0;
            let exactTime = null;

            if (busType === "GGI BUS") {
                let originList, destList;

                // 1. Al Nahda -> Mamzar
                if (origin === "Al Nahda" && dest === "Mamzar") {
                    originList = isSunday ? timetable["Al Nahda"].ggiSun : timetable["Al Nahda"].ggiMonSat;
                    destList = isSunday ? timetable.Mamzar.ggiOutSun : timetable.Mamzar.ggiOutMonSat;
                }
                // 2. Mamzar -> GGI
                else if (origin === "Mamzar" && dest === "GGI") {
                    originList = isSunday ? timetable.Mamzar.ggiOutSun : timetable.Mamzar.ggiOutMonSat;
                    // We need GGI arrival times. We stored GGI departures.
                    // Usually arrival is same as departure for turnaround, or slightly earlier.
                    // Let's assume GGI Departure list is the Arrival list (turnaround).
                    destList = isSunday ? timetable.GGI.sunday : timetable.GGI.monSat;
                }
                // 3. GGI -> Mamzar
                else if (origin === "GGI" && dest === "Mamzar") {
                    originList = isSunday ? timetable.GGI.sunday : timetable.GGI.monSat;
                    destList = isSunday ? timetable.Mamzar.ggiRetSun : timetable.Mamzar.ggiRetMonSat;
                }
                // 4. Mamzar -> Al Nahda
                else if (origin === "Mamzar" && dest === "Al Nahda") {
                    originList = isSunday ? timetable.Mamzar.ggiRetSun : timetable.Mamzar.ggiRetMonSat;
                    // We need Al Nahda End times. We didn't explicitly put them in 'timetable' object under 'Al Nahda' keys used for departure.
                    // But we have them in python variables. I should probably add them to the timetable object if we want exact times.
                    // For now, let's use heuristics for this leg if we don't have the list.
                }

                if (originList && destList) {
                    const idx = originList.indexOf(departStr);
                    if (idx !== -1 && idx < destList.length) {
                        exactTime = destList[idx];
                    }
                }
            }

            if (exactTime) {
                return makeDateFromHM(exactTime, departDate);
            }

            // heuristic fallback
            let key = `${origin}->${dest}`;
            let mins = TRAVEL_MINUTES[key] || 15;
            const arr = new Date(departDate.getTime() + mins * 60000);
            return arr;
        }

        /* UI wiring & logic */
        const originEl = document.getElementById('origin');
        const destEl = document.getElementById('destination');
        const timeInput = document.getElementById('timeInput');
        const nowBtn = document.getElementById('nowBtn');
        const findBtn = document.getElementById('findBtn');

        const statusEl = document.getElementById('status');
        const nextTimeEl = document.getElementById('nextTime');
        const minutesRemainEl = document.getElementById('minutesRemain');
        const nextFromEl = document.getElementById('nextFrom');
        const upcomingShortEl = document.getElementById('upcomingShort');

        const leftStopEl = document.getElementById('leftStop');
        const leftTimeEl = document.getElementById('leftTime');
        const rightStopEl = document.getElementById('rightStop');
        const rightTimeEl = document.getElementById('rightTime');
        const busDot = document.getElementById('busDot');
        const busETA = document.getElementById('busETA');
        const upListGrid = document.getElementById('upListGrid');

        function setNowToInput() {
            const now = new Date();
            timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        nowBtn.onclick = () => setNowToInput();
        setNowToInput();

        function showStatus(txt) { statusEl.innerHTML = `<div class="mini">${txt}</div>`; }

        function computeAndRender() {
            const origin = originEl.value;
            const dest = destEl.value;
            const timeVal = timeInput.value;
            if (!origin || origin === "Choose..." || !dest || dest === "Choose...") {
                showStatus("Select origin and destination");
                return;
            }
            if (origin === dest) {
                showStatus("Origin and destination are the same.");
                return;
            }
            if (!timeVal) {
                showStatus("Set the time (Use Now)");
                return;
            }
            // create now date based on input
            const nowParts = timeVal.split(':').map(x => parseInt(x, 10));
            const now = new Date();
            now.setHours(nowParts[0], nowParts[1], 0, 0);

            // get schedule list and convert to dates
            const schedData = getScheduleList(origin, dest); // returns { list, type }
            const schedDates = schedData.list.map(s => ({ str: s, date: makeDateFromHM(s, now) })).sort((a, b) => a.date - b.date);

            // find next departure after now
            const next = schedDates.find(s => s.date > now);
            if (!next) {
                showStatus("No more buses today");
                nextTimeEl.textContent = "--:--";
                minutesRemainEl.textContent = "--";
                nextFromEl.textContent = `${origin} â†’ ${dest}`;
                renderUpcoming(schedDates, now, schedData.type);
                renderRouteVisual(null, origin, dest, now, schedData.type);
                return;
            }
            const minutes = Math.ceil((next.date - now) / 60000);
            nextTimeEl.textContent = next.str;
            minutesRemainEl.textContent = String(minutes);
            nextFromEl.innerHTML = `${origin} &rarr; ${dest} <span style="opacity:0.6;margin-left:8px;font-size:0.9em;border:1px solid var(--muted);padding:2px 4px;border-radius:4px">${schedData.type}</span>`;
            showStatus(`${origin} â†’ ${dest} â€” next departure found`);
            // create arrival estimate
            const arrival = estimateArrival(origin, dest, next.date, next.str, schedData.type);
            // render upcoming list (short)
            const nextFew = schedDates.filter(s => s.date >= now).slice(0, 8);
            const shortHtml = nextFew.map(s => `<div style="display:inline-block;margin-right:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700">${s.str}</div>`).join('');
            upcomingShortEl.innerHTML = shortHtml;
            renderUpcoming(schedDates, now, schedData.type);
            renderRouteVisual({ depart: next, arrival }, origin, dest, now, schedData.type);
        }

        /* render upcoming grid with left/right times for each upcoming departure */
        function renderUpcoming(schedDates, now, busType) {
            upListGrid.innerHTML = '';
            // pick next 6 departures
            const nextOnes = schedDates.filter(s => s.date >= now).slice(0, 6);
            if (nextOnes.length === 0) {
                upListGrid.innerHTML = '<div class="mini muted">No upcoming departures</div>';
                return;
            }
            nextOnes.forEach(s => {
                // arrival estimate using current origin/dest
                const origin = originEl.value, dest = destEl.value;
                const arrival = estimateArrival(origin, dest, s.date, s.str, busType);
                const left = `<div style="display:flex;align-items:center"><div class="dot"></div><div style="font-weight:700">${s.str}</div></div>`;
                const right = `<div style="text-align:right"><div style="font-weight:700">${formatTime(arrival)}</div><div class="mini muted">arr</div></div>`;
                const wrapper = document.createElement('div');
                wrapper.className = 'upItem';
                wrapper.innerHTML = `${left}${right}`;
                upListGrid.appendChild(wrapper);
            });
        }

        function formatTime(d) {
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        /* render the main route visualization and animate the bus along the dotted line */
        let animInterval = null;
        function renderRouteVisual(nextObj, origin, dest, now, busType) {
            // set labels
            leftStopEl.textContent = origin;
            rightStopEl.textContent = dest;
            if (!nextObj) {
                leftTimeEl.textContent = "--:--";
                rightTimeEl.textContent = "--:--";
                busDot.style.left = "6%";
                busETA.textContent = "";
                return;
            }
            const depart = nextObj.depart; // {str, date}
            const arrival = nextObj.arrival; // Date
            leftTimeEl.textContent = depart.str;
            rightTimeEl.textContent = formatTime(arrival);
            busETA.textContent = `arr ${formatTime(arrival)}`;

            // compute progress and animate: progress = (now - depart) / (arrival - depart)
            function updatePosition() {
                const timeVal = timeInput.value;
                const nowParts = timeVal.split(':').map(x => parseInt(x, 10));
                const curr = new Date(); curr.setHours(nowParts[0], nowParts[1], 0, 0);
                let progress;
                if (curr < depart.date) {
                    progress = 0;
                } else if (curr >= arrival) {
                    progress = 1;
                } else {
                    const total = arrival - depart.date;
                    const passed = curr - depart.date;
                    progress = passed / total;
                    if (progress < 0) progress = 0;
                    if (progress > 1) progress = 1;
                }
                // map progress 0..1 to left..right % (6%..94%)
                const leftBound = 6; const rightBound = 94;
                const pos = leftBound + (rightBound - leftBound) * progress;
                busDot.style.left = pos + '%';

                // change icon/text based on state
                const minutesToDepart = Math.ceil((depart.date - curr) / 60000);
                if (minutesToDepart > 0) {
                    // not departed yet - bus at origin
                    busETA.textContent = `dep ${depart.str}`;
                    busDot.style.opacity = 0.96;
                    busDot.style.transform = 'translate(-50%,-50%) scale(1)';
                } else if (curr >= arrival) {
                    busETA.textContent = `arr ${formatTime(arrival)}`;
                    busDot.style.opacity = 0.6;
                    busDot.style.transform = 'translate(-50%,-50%) scale(.95)';
                } else {
                    const minsLeft = Math.ceil((arrival - curr) / 60000);
                    busETA.textContent = `${minsLeft}m to arr`;
                    busDot.style.opacity = 1;
                    // subtle animation along path
                    busDot.style.transform = 'translate(-50%,-50%) scale(1)';
                }

                // update bus type label
                if (busType) {
                    const existing = busETA.innerHTML;
                    if (!existing.includes(busType)) {
                        busETA.innerHTML = `<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">${busType}</div>` + existing;
                    }
                }
            }

            // run update now and start interval
            updatePosition();
            if (animInterval) clearInterval(animInterval);
            animInterval = setInterval(updatePosition, 10 * 1000); // every 10s
        }

        /* wire events */
        findBtn.onclick = computeAndRender;
        document.addEventListener('keydown', (e) => { if (e.key === 'Enter') computeAndRender(); });
        originEl.addEventListener('change', computeAndRender);
        destEl.addEventListener('change', computeAndRender);
        timeInput.addEventListener('change', computeAndRender);

        /* initial demo */
        computeAndRender();
    </script>

</body>

</html>