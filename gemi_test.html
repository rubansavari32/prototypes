<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GGI Shuttle â€” Next Bus Visual (animated)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #071223;
            --card: #071523;
            --muted: #98a7bb;
            --accent: #10b98a;
            --glass: rgba(255, 255, 255, 0.02);
            --glass-2: rgba(255, 255, 255, 0.03);
            --white: #e9f2fb;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
            margin: 0;
            background:
                radial-gradient(1200px 500px at 10% 5%, rgba(16, 185, 129, 0.04), transparent 8%),
                linear-gradient(180deg, #041122 0%, #061628 60%);
            color: var(--white);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 28px
        }

        .app {
            width: 100%;
            max-width: 1040px
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px
        }

        h1 {
            margin: 0;
            font-size: 20px
        }

        .card {
            background: linear-gradient(180deg, var(--card), #05131a);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(6px)
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 18px
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 8px
        }

        select,
        input[type="time"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: var(--glass);
            color: inherit
        }

        .controls {
            display: grid;
            gap: 12px
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        button {
            background: var(--accent);
            border: none;
            color: #012018;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .statusCard {
            padding: 14px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(16, 185, 138, 0.03), rgba(16, 185, 138, 0.01));
            border: 1px solid rgba(16, 185, 138, 0.08)
        }

        .controlsCard {
            padding: 18px;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01))
        }

        .findRow {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end
        }

        .visualCard {
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 30px 20px;
            margin-top: 18px;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center
        }

        .routeLine {
            position: absolute;
            top: 50%;
            left: 6%;
            right: 6%;
            height: 2px;
            background: repeating-linear-gradient(90deg, var(--muted) 0, var(--muted) 4px, transparent 4px, transparent 8px);
            opacity: 0.3;
            transform: translateY(-50%)
        }

        .stop {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--card);
            border: 2px solid var(--muted);
            border-radius: 50%;
            z-index: 2
        }

        .stop.left {
            left: 6%
        }

        .stop.right {
            right: 6%
        }

        .busDot {
            position: absolute;
            top: 50%;
            left: 6%;
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 15px rgba(16, 185, 138, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #012018;
            font-weight: bold;
            transition: left 1s linear, transform 0.3s ease
        }

        .stopLabel {
            position: absolute;
            top: calc(50% + 18px);
            font-size: 12px;
            color: var(--muted);
            transform: translateX(-50%);
            white-space: nowrap
        }

        .timeLabel {
            position: absolute;
            top: calc(50% - 28px);
            font-size: 14px;
            font-weight: 600;
            transform: translateX(-50%)
        }

        .busLabel {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            color: var(--accent);
            border: 1px solid rgba(16, 185, 138, 0.3)
        }

        .bigTime {
            font-size: 32px;
            font-weight: 700;
            margin: 4px 0
        }

        .metaGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 18px
        }

        .metaItem {
            background: var(--glass);
            padding: 12px;
            border-radius: 8px
        }

        .upList {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 12px
        }

        .upItem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--glass-2);
            border-radius: 8px;
            font-size: 14px
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            margin-right: 10px;
            opacity: 0.5
        }

        .mini {
            font-size: 12px;
            opacity: 0.7
        }

        @media(max-width:700px) {
            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>

    <div class="app">
        <header>
            <div
                style="width:32px;height:32px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#012018;font-weight:bold">
                B</div>
            <h1>GGI Shuttle Dashboard</h1>
        </header>

        <div class="grid">
            <div class="mainCol">
                <div class="card">
                    <div class="controls">
                        <div class="row">
                            <div style="flex:1">
                                <label>Origin</label>
                                <select id="origin">
                                    <option selected>Al Nahda</option>
                                    <option>Mamzar</option>
                                    <option>GGI</option>
                                    <option>Stadium</option>
                                </select>
                            </div>
                            <div style="flex:1">
                                <label>Destination</label>
                                <select id="destination">
                                    <option>Choose...</option>
                                    <option>Al Nahda</option>
                                    <option>Mamzar</option>
                                    <option>GGI</option>
                                    <option>Stadium</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div style="flex:1">
                                <label>Time</label>
                                <div class="row" style="gap:8px">
                                    <input type="time" id="timeInput" />
                                    <button id="nowBtn"
                                        style="padding:10px;background:var(--glass);color:var(--accent);border:1px solid rgba(16,185,138,0.2)">Now</button>
                                </div>
                            </div>
                        </div>
                        <div class="findRow">
                            <button id="findBtn" style="width:100%">Find Next Bus</button>
                        </div>
                    </div>

                    <div id="status" style="margin-top:12px;min-height:20px;color:var(--accent)"></div>

                    <div class="visualCard">
                        <div class="routeLine"></div>

                        <div class="stop left"></div>
                        <div class="stopLabel" style="left:6%" id="leftStop">Origin</div>
                        <div class="timeLabel" style="left:6%" id="leftTime">--:--</div>

                        <div class="stop right"></div>
                        <div class="stopLabel" style="right:6%" id="rightStop">Dest</div>
                        <div class="timeLabel" style="right:6%" id="rightTime">--:--</div>

                        <div class="busDot" id="busDot">
                            <div style="font-size:18px">ðŸšŒ</div>
                            <div class="busLabel" id="busETA"></div>
                        </div>
                    </div>

                </div>

                <div style="margin-top:18px">
                    <label>Later Departures</label>
                    <div id="upcomingShort" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:8px"></div>
                </div>
            </div>

            <div class="sideCol">
                <div class="card statusCard">
                    <div class="muted">Next Departure</div>
                    <div class="bigTime" id="nextTime">--:--</div>
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                        <span style="color:var(--accent);font-weight:700" id="minutesRemain">--</span>
                        <span class="muted">min remaining</span>
                    </div>
                    <div class="mini" id="nextFrom">--</div>
                </div>

                <div class="card" style="margin-top:18px">
                    <label>Upcoming Schedule</label>
                    <div class="upList" id="upListGrid">
                        <div class="mini muted">Select route to see schedule</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ---------- sample timetable (same compact sample) ---------- */
        const timetable = {
           /*GGI bus */ "Mamzar": {
                outbound: ["05:25", "06:20", "06:40", "07:05", "07:30", "08:00", "08:30", "09:10", "10:20", "11:20", "12:20", "13:00", "13:25", "13:50", "14:20", "14:40", "15:05", "15:45", "16:10", "16:50", "17:25", "18:00", "18:35", "19:00", "19:30", "20:00", "20:25", "21:00", "21:20", "21:30", "22:10", "22:30", "22:55", "23:15"],
                return: ["06:48", "07:10", "07:35", "08:00", "08:25", "08:55", "09:35", "10:50", "11:50", "12:50", "13:30", "13:55", "14:20", "14:48", "15:10", "15:35", "16:15", "16:38", "17:20", "17:55", "18:30", "19:05", "19:30", "20:05", "20:30", "20:55", "21:28", "21:50", "22:00", "22:38", "22:58", "23:23", "23:45", "00:25", "01:25"],
    /*STD bus */stadiumMonSat: ["05:30", "06:25", "06:45", "07:30", "08:00", "08:30", "09:20", "10:20", "11:20", "12:20", "13:00", "13:25", "13:55", "14:25", "14:50", "15:35", "16:05", "16:40", "17:25", "18:00", "18:35", "19:00", "19:30", "20:00", "20:25", "21:10", "21:25", "22:00", "22:25", "22:40"],
                stadiumSun: ["09:30", "11:20", "12:20", "13:05", "13:35", "14:20", "14:42", "14:55", "15:40", "16:05", "16:35", "17:10", "17:40", "18:10", "18:40", "19:05", "19:35", "20:05", "20:30", "21:10", "21:30", "22:35"]
            },
            "Al Nahda": {
                outbound: ["05:15", "06:10", "06:30", "06:55", "07:15", "07:50", "08:15", "09:00", "10:10", "11:10", "12:10", "12:45", "13:10", "13:40", "14:10", "14:30", "14:55", "15:35", "16:00", "16:35", "17:15", "17:50", "18:20", "18:50", "19:15", "19:45", "20:10", "20:45", "21:05", "21:15", "22:00", "22:20", "22:45", "23:05"],
                return: ["06:53", "07:15", "07:45", "08:10", "08:40", "09:10", "09:50", "11:00", "12:00", "13:00", "13:35", "14:05", "14:30", "14:53", "15:20", "15:45", "16:20", "16:43", "17:30", "18:05", "18:40", "19:15", "19:40", "20:15", "20:40", "21:05", "21:33", "22:00", "22:10", "22:43", "23:03", "23:28", "23:50", "00:30"],

                stadiumMonSat: ["05:20", "06:15", "06:35", "07:15", "07:50", "08:15", "09:10", "10:10", "11:10", "12:10", "12:45", "13:10", "13:40", "14:15", "14:40", "15:25", "16:00", "16:30", "17:15", "17:50", "18:25", "18:50", "19:15", "19:45", "20:10", "20:55", "21:10", "21:50", "22:15", "22:30"],
                stadiumSun: ["09:20", "11:10", "12:10", "12:55", "13:25", "14:10", "14:30", "14:45", "15:30", "15:55", "16:25", "17:00", "17:30", "18:00", "18:30", "18:55", "19:25", "19:55", "20:20", "21:00", "21:20", "22:25"]
            },
            "GGI": {
                times: ["05:40", "06:35", "06:55", "07:20", "07:45", "08:15", "08:45", "09:25", "10:35", "11:35", "12:35", "13:15", "13:40", "14:05", "14:35", "14:55", "15:20", "16:00", "16:25", "17:05", "17:40", "18:15", "18:50", "19:15", "19:45", "20:15", "20:40", "21:15", "21:35", "21:45", "22:25", "22:45", "23:10", "23:30", "00:10", "01:10"]
            },
            "Stadium": {
                monSat: {
                    toAlNahda: ["00:30", "05:40", "06:35", "06:55", "07:40", "08:10", "08:40", "09:30", "10:30", "11:30", "12:30", "13:10", "13:40", "14:10", "14:40", "15:05", "15:45", "16:15", "16:50", "17:35", "18:10", "18:45", "19:10", "19:40", "20:10", "20:35", "21:20", "21:35", "22:08", "22:35", "22:50", "23:15"],
                    toMamzar: ["00:30", "05:40", "06:35", "06:55", "07:40", "08:10", "08:40", "09:30", "10:30", "11:30", "12:30", "13:10", "13:40", "14:10", "14:40", "15:05", "15:45", "16:15", "16:50", "17:35", "18:10", "18:45", "19:10", "19:40", "20:10", "20:35", "21:20", "21:35", "22:08", "22:35", "22:50", "23:15"]
                },
                sunday: {
                    toAlNahda: ["00:40", "09:40", "10:45", "11:30", "12:30", "13:13", "13:43", "14:30", "14:50", "15:10", "15:50", "16:13", "16:43", "17:20", "17:50", "18:20", "18:50", "19:13", "19:43", "20:13", "20:40", "21:20", "21:40", "22:45", "23:15"],
                    toMamzar: ["00:40", "09:40", "10:45", "11:30", "12:30", "13:13", "13:43", "14:30", "14:50", "15:10", "15:50", "16:13", "16:43", "17:20", "17:50", "18:20", "18:50", "19:13", "19:43", "20:13", "20:40", "21:20", "21:40", "22:45", "23:15"]
                }
            }
        };

        /* heuristics for travel durations (minutes) - adjust to your real parsed data later */
        const TRAVEL_MINUTES = {
            "Mamzar->GGI": 15,
            "Mamzar->Al Nahda": 5,
            "GGI->Mamzar": 13,
            "GGI->Al Nahda": 33,
            "Al Nahda->Mamzar": 15,
            "Al Nahda->GGI": 30,
            "Al Nahda->Stadium": 20,
            "Stadium->Al Nahda": 20,
            "Mamzar->Stadium": 10,
            "Stadium->Mamzar": 10
        };

        /* helpers */
        function parseHM(hm) {
            const [h, m] = hm.split(':').map(x => parseInt(x, 10));
            return { h, m };
        }
        function makeDateFromHM(hm, baseDate = new Date()) {
            const { h, m } = parseHM(hm);
            const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h, m, 0);
            return normalizeScheduleDate(d, baseDate);
        }
        function normalizeScheduleDate(schedDate, nowDate) {
            // if schedule time is >12 hours behind, consider next day (handles midnight wrap)
            if ((schedDate - nowDate) < -12 * 3600 * 1000) {
                schedDate.setDate(schedDate.getDate() + 1);
            }
            return schedDate;
        }
        function minutesBetween(a, b) { return Math.round((b - a) / 60000); }

        /* find next schedule list for origin->dest */
        function getScheduleList(origin, dest) {
            // Check if today is Sunday (0 = Sunday in JS)
            const isSunday = new Date().getDay() === 0;

            // --- Stadium Logic ---
            if (dest === "Stadium") {
                if (origin === "Al Nahda") return { list: isSunday ? timetable["Al Nahda"].stadiumSun : timetable["Al Nahda"].stadiumMonSat, type: "STD BUS" };
                if (origin === "Mamzar") return { list: isSunday ? timetable.Mamzar.stadiumSun : timetable.Mamzar.stadiumMonSat, type: "STD BUS" };
            }
            if (origin === "Stadium") {
                if (dest === "Al Nahda") return { list: isSunday ? timetable.Stadium.sunday.toAlNahda : timetable.Stadium.monSat.toAlNahda, type: "STD BUS" };
                if (dest === "Mamzar") return { list: isSunday ? timetable.Stadium.sunday.toMamzar : timetable.Stadium.monSat.toMamzar, type: "STD BUS" };
            }

            // --- Original Logic ---
            // --- Original Logic ---
            if (origin === "Mamzar" && dest === "GGI") return { list: timetable.Mamzar.outbound, type: "GGI BUS" };
            if (origin === "Mamzar" && dest === "Al Nahda") return { list: timetable.Mamzar.return, type: "GGI BUS" };
            if (origin === "Al Nahda" && dest === "Mamzar") return { list: timetable["Al Nahda"].outbound, type: "GGI BUS" };
            if (origin === "Al Nahda" && dest === "GGI") return { list: timetable["Al Nahda"].outbound, type: "GGI BUS" };
            if (origin === "GGI" && dest === "Mamzar") return { list: timetable.GGI.times, type: "GGI BUS" };
            if (origin === "GGI" && dest === "Al Nahda") return { list: timetable.GGI.times, type: "GGI BUS" };
            return { list: [], type: "" };
        }

        function estimateArrival(origin, dest, departDate, departStr, busType) {
            // try to find exact arrival from aligned arrays for GGI buses
            let exactTime = null;
            if (busType === "GGI BUS") {
                if (origin === "Al Nahda" && dest === "Mamzar") {
                    const idx = timetable["Al Nahda"].outbound.indexOf(departStr);
                    if (idx !== -1) exactTime = timetable.Mamzar.outbound[idx];
                } else if (origin === "Mamzar" && dest === "GGI") {
                    const idx = timetable.Mamzar.outbound.indexOf(departStr);
                    if (idx !== -1) exactTime = timetable.GGI.times[idx];
                } else if (origin === "Mamzar" && dest === "Al Nahda") {
                    const idx = timetable.Mamzar.return.indexOf(departStr);
                    if (idx !== -1) exactTime = timetable["Al Nahda"].return[idx];
                }
            }

            if (exactTime) {
                return makeDateFromHM(exactTime, departDate);
            }

            // heuristic fallback
            let key = `${origin}->${dest}`;
            let mins = TRAVEL_MINUTES[key] || 15;
            const arr = new Date(departDate.getTime() + mins * 60000);
            return arr;
        }

        /* UI wiring & logic */
        const originEl = document.getElementById('origin');
        const destEl = document.getElementById('destination');
        const timeInput = document.getElementById('timeInput');
        const nowBtn = document.getElementById('nowBtn');
        const findBtn = document.getElementById('findBtn');

        const statusEl = document.getElementById('status');
        const nextTimeEl = document.getElementById('nextTime');
        const minutesRemainEl = document.getElementById('minutesRemain');
        const nextFromEl = document.getElementById('nextFrom');
        const upcomingShortEl = document.getElementById('upcomingShort');

        const leftStopEl = document.getElementById('leftStop');
        const leftTimeEl = document.getElementById('leftTime');
        const rightStopEl = document.getElementById('rightStop');
        const rightTimeEl = document.getElementById('rightTime');
        const busDot = document.getElementById('busDot');
        const busETA = document.getElementById('busETA');
        const upListGrid = document.getElementById('upListGrid');

        function setNowToInput() {
            const now = new Date();
            timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        nowBtn.onclick = () => setNowToInput();
        setNowToInput();

        function showStatus(txt) { statusEl.innerHTML = `<div class="mini">${txt}</div>`; }

        function computeAndRender() {
            const origin = originEl.value;
            const dest = destEl.value;
            const timeVal = timeInput.value;
            if (!origin || origin === "Choose..." || !dest || dest === "Choose...") {
                showStatus("Select origin and destination");
                return;
            }
            if (origin === dest) {
                showStatus("Origin and destination are the same.");
                return;
            }
            if (!timeVal) {
                showStatus("Set the time (Use Now)");
                return;
            }
            // create now date based on input
            const nowParts = timeVal.split(':').map(x => parseInt(x, 10));
            const now = new Date();
            now.setHours(nowParts[0], nowParts[1], 0, 0);

            // get schedule list and convert to dates
            const schedData = getScheduleList(origin, dest); // returns { list, type }
            const schedDates = schedData.list.map(s => ({ str: s, date: makeDateFromHM(s, now) })).sort((a, b) => a.date - b.date);

            // find next departure after now
            const next = schedDates.find(s => s.date > now);
            if (!next) {
                showStatus("No more buses today");
                nextTimeEl.textContent = "--:--";
                minutesRemainEl.textContent = "--";
                nextFromEl.textContent = `${origin} â†’ ${dest}`;
                renderUpcoming(schedDates, now, schedData.type);
                renderRouteVisual(null, origin, dest, now, schedData.type);
                return;
            }
            const minutes = Math.ceil((next.date - now) / 60000);
            nextTimeEl.textContent = next.str;
            minutesRemainEl.textContent = String(minutes);
            nextFromEl.innerHTML = `${origin} &rarr; ${dest} <span style="opacity:0.6;margin-left:8px;font-size:0.9em;border:1px solid var(--muted);padding:2px 4px;border-radius:4px">${schedData.type}</span>`;
            showStatus(`${origin} â†’ ${dest} â€” next departure found`);
            // create arrival estimate
            const arrival = estimateArrival(origin, dest, next.date, next.str, schedData.type);
            // render upcoming list (short)
            const nextFew = schedDates.filter(s => s.date >= now).slice(0, 8);
            const shortHtml = nextFew.map(s => `<div style="display:inline-block;margin-right:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700">${s.str}</div>`).join('');
            upcomingShortEl.innerHTML = shortHtml;
            renderUpcoming(schedDates, now, schedData.type);
            renderRouteVisual({ depart: next, arrival }, origin, dest, now, schedData.type);
        }

        /* render upcoming grid with left/right times for each upcoming departure */
        function renderUpcoming(schedDates, now, busType) {
            upListGrid.innerHTML = '';
            // pick next 6 departures
            const nextOnes = schedDates.filter(s => s.date >= now).slice(0, 6);
            if (nextOnes.length === 0) {
                upListGrid.innerHTML = '<div class="mini muted">No upcoming departures</div>';
                return;
            }
            nextOnes.forEach(s => {
                // arrival estimate using current origin/dest
                const origin = originEl.value, dest = destEl.value;
                const arrival = estimateArrival(origin, dest, s.date, s.str, busType);
                const left = `<div style="display:flex;align-items:center"><div class="dot"></div><div style="font-weight:700">${s.str}</div></div>`;
                const right = `<div style="text-align:right"><div style="font-weight:700">${formatTime(arrival)}</div><div class="mini muted">arr</div></div>`;
                const wrapper = document.createElement('div');
                wrapper.className = 'upItem';
                wrapper.innerHTML = `${left}${right}`;
                upListGrid.appendChild(wrapper);
            });
        }

        function formatTime(d) {
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        /* render the main route visualization and animate the bus along the dotted line */
        let animInterval = null;
        function renderRouteVisual(nextObj, origin, dest, now, busType) {
            // set labels
            leftStopEl.textContent = origin;
            rightStopEl.textContent = dest;
            if (!nextObj) {
                leftTimeEl.textContent = "--:--";
                rightTimeEl.textContent = "--:--";
                busDot.style.left = "6%";
                busETA.textContent = "";
                return;
            }
            const depart = nextObj.depart; // {str, date}
            const arrival = nextObj.arrival; // Date
            leftTimeEl.textContent = depart.str;
            rightTimeEl.textContent = formatTime(arrival);
            busETA.textContent = `arr ${formatTime(arrival)}`;

            // compute progress and animate: progress = (now - depart) / (arrival - depart)
            function updatePosition() {
                const timeVal = timeInput.value;
                const nowParts = timeVal.split(':').map(x => parseInt(x, 10));
                const curr = new Date(); curr.setHours(nowParts[0], nowParts[1], 0, 0);
                let progress;
                if (curr < depart.date) {
                    progress = 0;
                } else if (curr >= arrival) {
                    progress = 1;
                } else {
                    const total = arrival - depart.date;
                    const passed = curr - depart.date;
                    progress = passed / total;
                    if (progress < 0) progress = 0;
                    if (progress > 1) progress = 1;
                }
                // map progress 0..1 to left..right % (6%..94%)
                const leftBound = 6; const rightBound = 94;
                const pos = leftBound + (rightBound - leftBound) * progress;
                busDot.style.left = pos + '%';

                // change icon/text based on state
                const minutesToDepart = Math.ceil((depart.date - curr) / 60000);
                if (minutesToDepart > 0) {
                    // not departed yet - bus at origin
                    busETA.textContent = `dep ${depart.str}`;
                    busDot.style.opacity = 0.96;
                    busDot.style.transform = 'translate(-50%,-50%) scale(1)';
                } else if (curr >= arrival) {
                    busETA.textContent = `arr ${formatTime(arrival)}`;
                    busDot.style.opacity = 0.6;
                    busDot.style.transform = 'translate(-50%,-50%) scale(.95)';
                } else {
                    const minsLeft = Math.ceil((arrival - curr) / 60000);
                    busETA.textContent = `${minsLeft}m to arr`;
                    busDot.style.opacity = 1;
                    // subtle animation along path
                    busDot.style.transform = 'translate(-50%,-50%) scale(1)';
                }

                // Add bus type label if space permits, or just reuse the existing label logic
                // We can append the type to the busETA text or a separate element
                if (busType) {
                    // busETA.innerHTML += `<div style="font-size:0.7em;opacity:0.8;margin-top:2px">${busType}</div>`;
                    // Actually let's just prepend it to the text if it's not too long
                    // Or put it in a separate small pill on top
                    const existing = busETA.innerHTML;
                    if (!existing.includes(busType)) {
                        busETA.innerHTML = `<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">${busType}</div>` + existing;
                    }
                }
            }

            // run update now and start interval
            updatePosition();
            if (animInterval) clearInterval(animInterval);
            animInterval = setInterval(updatePosition, 10 * 1000); // every 10s
        }

        /* wire events */
        findBtn.onclick = computeAndRender;
        document.addEventListener('keydown', (e) => { if (e.key === 'Enter') computeAndRender(); });
        originEl.addEventListener('change', computeAndRender);
        destEl.addEventListener('change', computeAndRender);
        timeInput.addEventListener('change', computeAndRender);

        /* initial demo */
        computeAndRender();
    </script>

</body>

</html>